.DEFAULT_GOAL	:= build
SHELL		:= /bin/bash

DESTDIR		:= $(CURDIR)/make_target
REDHATOS	:= $(wildcard /etc/redhat-release*)
DEBIANOS	:= $(wildcard /etc/debian_version*)

ifneq ($(DEBIANOS),)
PKG_INSTALLER := apt
else ifneq ($(REDHATOS),)
PKG_INSTALLER := yum
endif

include ../rust.makefile

DOC_EXAMPLES := $(wildcard docs/examples/*.rl)

cargo:
	curl https://sh.rustup.rs -sSf | sh -s -- -y

# should not be necessary either
deps:
	$(PKG_INSTALLER) update && $(PKG_INSTALLER) install -y perl python python3 python3-jsondiff python3-docopt python-jsondiff python-docopt

build: deps
	cargo build --release

postinstall:
	$(DESTDIR)/opt/rudder/share/rudder-lang/tools/generate_lib

install:
	mkdir -p $(DESTDIR)/opt/rudder/etc
	mkdir -p $(DESTDIR)/opt/rudder/bin
	mkdir -p $(DESTDIR)/opt/rudder/share/python
	mkdir -p $(DESTDIR)/opt/rudder/share/rudder-lang/lib
	mkdir -p $(DESTDIR)/opt/rudder/share/rudder-lang/tools

	# Install executable and helper scripts
	install -m 755 target/release/rudderc $(DESTDIR)/opt/rudder/bin/rudderc
	install -m 755 tools/tester.sh $(DESTDIR)/opt/rudder/share/rudder-lang/tools/tester.sh
	install -m 755 tools/cfjson_tester $(DESTDIR)/opt/rudder/share/rudder-lang/tools/cfjson_tester
	install -m 755 tools/generate_lib $(DESTDIR)/opt/rudder/share/rudder-lang/tools/generate_lib
	
	# Copy configuration and library files
	# required for rudderc execution
	install -m 640 tools/rudderc.conf $(DESTDIR)/opt/rudder/etc/rudderc.conf
	install -m 644 tools/docopt.py $(DESTDIR)/opt/rudder/share/python/docopt.py
	install -m 644 libs/corelib.rl $(DESTDIR)/opt/rudder/share/rudder-lang/lib/corelib.rl
	install -m 644 libs/cfengine_core.rl $(DESTDIR)/opt/rudder/share/rudder-lang/lib/cfengine_core.rl
	install -m 644 libs/oslib.rl $(DESTDIR)/opt/rudder/share/rudder-lang/lib/oslib.rl
	cp -r tools/jsondiff $(DESTDIR)/opt/rudder/share/python/ && chmod 755 $(DESTDIR)/opt/rudder/share/python/jsondiff && chmod 644 $(DESTDIR)/opt/rudder/share/python/jsondiff/*

	# Not sure these should be copied on the server
	# required by rudder lang at `cargo build` time
	# install -m 644 tools/osbuilder.ron $(DESTDIR)/opt/rudder/share/rudder-lang/tools/osbuilder.ron
	# generated by generate_lib
	# install -m 644 libs/stdlib.rl $(DESTDIR)/opt/rudder/share/rudder-lang/lib/stdlib.rl
	# install -m 644 tools/translate_config.toml $(DESTDIR)/opt/rudder/share/rudder-lang/tools/translate_config.toml

test-docs: $(DOC_EXAMPLES)

$(DOC_EXAMPLES):
	cargo run -- --config-file tools/rudderc-dev.conf --input $@ --output $@.cf
	rm $@.cf

docs:
	mkdir -p target/docs
	asciidoctor --destination-dir=target/docs docs/index.adoc

.PHONY: docs $(DOC_EXAMPLES)

