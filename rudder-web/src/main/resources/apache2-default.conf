<VirtualHost *:80>
	ServerAdmin webmaster@localhost

	# Rudder webapp
	RewriteEngine on
	RewriteRule   ^/$  /rudder [R]

	ProxyPass         "/rudder" "http://localhost:8080/rudder"
	ProxyPassReverse  "/rudder" "http://localhost:8080/rudder"
	ProxyRequests     Off

	# Local reverse proxy authorization override
	# Most unix distribution deny proxy by default (ie /etc/apache2/mods-enabled/proxy.conf in Ubuntu)
	<Proxy http://localhost:8080/rudder*>
		Order deny,allow
		Allow from all
	</Proxy>

	# Prevent Chrome loop detection to block the page after too many
	# page reloads.
	<LocationMatch "/rudder">
		Header add X-Chrome-Exponential-Throttling "disable"
	</LocationMatch>

	# Nice loading page if the Java server is not ready
	DocumentRoot /opt/rudder/share/load-page
	ErrorDocument 503 /rudder-loading.html

	# Enforce permissive access to the load page directory
	<Directory /opt/rudder/share/load-page>
		Order deny,allow
		Allow From all
	</Directory>
	
	# Expose the server UUID through http
	Alias /uuid /opt/rudder/etc/uuid.hive
	<Directory /opt/rudder/etc>
		Order deny,allow
		Allow from all
	</Directory>

	# WebDAV share to receive inventories
	Alias /inventories /var/rudder/inventories/incoming
	<Directory /var/rudder/inventories/incoming>
		DAV on 
		AuthName "WebDAV Storage" 
		AuthType Basic
		AuthUserFile /opt/rudder/etc/htpasswd-webdav-initial
		Require valid-user
		Order deny,allow
		# This file is automatically generated according to
		# the hosts allowed by rudder.
		Include /opt/rudder/etc/rudder-networks.conf
		<LimitExcept PUT>
			Order allow,deny
			Deny from all
		</LimitExcept>
	</Directory>

	# WebDAV share to receive inventories
	Alias /inventory-updates /var/rudder/inventories/accepted-nodes-updates
	<Directory /var/rudder/inventories/accepted-nodes-updates>
		DAV on 
		AuthName "WebDAV Storage" 
		AuthType Basic
		AuthUserFile /opt/rudder/etc/htpasswd-webdav
		Require valid-user
		Order deny,allow
		# This file is automatically generated according to
		# the hosts allowed by rudder.
		Include /opt/rudder/etc/rudder-networks.conf
		<LimitExcept PUT>
			Order allow,deny
			Deny from all
		</LimitExcept>
	</Directory>

	# NO access to the API unless you are localhost
	<Location /rudder/api>
		Order deny,allow
		Deny from all
		Allow from localhost
	</Location>

	# Link to Rudder documentation
	Alias /rudder-doc /usr/share/doc/rudder
	<Directory /usr/share/doc/rudder>
		DirectoryIndex rudder-doc.html
		Order deny,allow
		Allow from all
	</Directory>

	# Logs
	ErrorLog %APACHE_ERRLOG_FILE%
	LogLevel warn
	CustomLog %APACHE_LOG_FILE% combined

</VirtualHost>
